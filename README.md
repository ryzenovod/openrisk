# credit-risk-mvp

Информационная система оценки и оптимизации кредитного риска с применением ИИ и спецификации OpenAPI.

## Концепция продукта (пересмотр)

Изначальная задумка — не отдельный сайт, а компактная панель, которую можно закрепить рядом с бизнес‑системой
или встроить как расширение браузера. Поэтому интерфейс ориентирован на узкие экраны и работу «в две колонки»:

- **Режим расширения**: UI открывается в сайдбаре браузера/плагина, тянет данные из backend и отображает ключевые
  KPI, скоринг, оптимизацию и очередь задач без перехода на отдельный сайт.
- **Встраивание в контекст**: тот же UI может быть iframe-панелью в CRM/ERP, чтобы скоринг и мониторинг
  происходили прямо в рабочем окне оператора.
- **Мобильный режим**: на узких экранах навигация превращается в выезжающее меню, карточки и таблицы
  переходят в одну колонку.

Это объясняет компактные виджеты, быстрые формы и отсутствие «толстых» страниц — всё рассчитано на быстрый взгляд.

## Запуск

```bash
docker compose up --build
```

Если после сборки backend падает с ошибкой `ImportError: no pq wrapper available`, убедитесь что используется `psycopg[binary]` (уже добавлено в `backend/requirements.txt`) и пересоберите контейнер.

Если frontend сообщает: `"next start" does not work with "output: standalone"`, запуск уже исправлен — контейнер стартует через `node .next/standalone/server.js`.

### Переменные окружения

| Переменная | Описание | Значение по умолчанию |
| --- | --- | --- |
| `DATABASE_URL` | строка подключения к Postgres | `postgresql+psycopg://postgres:postgres@db:5432/credit_risk` |
| `API_KEY` | ключ для заголовка `X-API-Key` | `local-dev-key` |
| `MODEL_PATH` | путь для модели ML | `/data/model.joblib` |
| `DATASET_PATH` | путь для синтетического датасета | `/data/dataset.csv` |
| `NEXT_PUBLIC_API_BASE` | базовый URL backend | `http://localhost:8000` |
| `NEXT_PUBLIC_API_KEY` | ключ для frontend запросов | `local-dev-key` |

## UI

- Dashboard: метрики, графики и последние job'ы.
- Score application: форма скоринга, PD/EL и факторы.
- Portfolio optimize: запуск job оптимизации портфеля.
- Jobs: список задач и статусов (SSE‑лог доступен на backend).

### Где взять API-ключ

- По умолчанию ключ: `local-dev-key` (см. `API_KEY` в `docker-compose.yml`).
- Можно заменить ключ, задав `API_KEY` в окружении backend и `NEXT_PUBLIC_API_KEY` для frontend.
- В интерфейсе ключ вводится в сайдбаре и сохраняется локально в браузере.

## API

- Backend: `http://localhost:8000`
- Docs: `http://localhost:8000/docs`
- OpenAPI: `http://localhost:8000/openapi.json`

## Как всё работает под капотом (метрики, графики, модель и потоки данных)

### 1. Потоки данных (end‑to‑end)

1. **UI → API**: frontend обращается к backend через `frontend/lib/api-client.ts` и передаёт `X-API-Key`.
2. **API → ML/DB**:
   - `/api/v1/score` валидирует вход, считает PD, пишет заявку и решение в БД.
   - `/api/v1/jobs` создаёт job и запускает асинхронный обработчик.
3. **DB → Dashboard**: `/api/v1/dashboard` собирает данные по заявкам, решениям и job'ам.

### 2. ML‑скоринг

- **Где живёт**: `backend/app/ml/model.py`.
- **Что делает**: обучает/грузит модель, возвращает `pd` и `top_factors`.
- **Как используется**: `backend/app/api/v1/routes.py` вызывает `score_application`, вычисляет
  **ожидаемые потери (EL)** по формуле `EL = PD * LGD * EAD`, где:
  - **PD** — вероятность дефолта (модель).
  - **LGD** — допущение 0.5 (константа в коде).
  - **EAD** — сумма кредита.

### 3. Таблицы БД и сущности

- `Application`: входные параметры клиента.
- `Decision`: результат скоринга (PD, EL, рекомендация).
- `Job` и `JobEvent`: очередь задач, прогресс и лог.

### 4. Дашборд: каждая метрика и каждый график

Источник — `backend/app/api/v1/routes.py` (эндпоинт `/api/v1/dashboard`).

#### Метрики (карточки вверху)

1. **Всего заявок** (`total_applications`)
   - Число записей `Application`.
   - Отвечает на вопрос: «сколько заявок уже прошло через систему».
2. **Доля одобрений** (`approved_rate`)
   - Доля решений, где `Decision.recommended == True`.
   - Показывает качество входящего потока и агрессивность скоринга.
3. **Средняя PD** (`average_pd`)
   - Среднее значение PD по всем решениям.
   - Чем выше, тем рисковее портфель.
4. **Ожидаемые потери портфеля** (`portfolio_el`)
   - Сумма `Decision.expected_loss` по всем решениям.
   - Это агрегированный риск в абсолютном денежном выражении.

#### График 1: «Распределение PD»

- **Откуда берётся**: список `Decision.pd`.
- **Что показывает**: плотность риска по портфелю (сколько заявок попадает в низкий/средний/высокий PD).
- **Почему важно**: позволяет визуально отделить «здоровую» часть портфеля от высокорисковой.

#### График 2: «EL во времени»

- **Откуда берётся**: история `Decision.expected_loss`.
- **Что показывает**: изменение ожидаемых потерь по последовательным решениям
  (как меняется риск на потоке).
- **Почему важно**: видны сдвиги качества выдачи и всплески риска.

#### Дополнительные данные дашборда

- **Последние job'ы** (`recent_jobs`) — отображаются в Jobs.
- **Прогресс job** (`job_durations`) — сервисные метрики для мониторинга очереди.

#### Реалистичное поведение метрик

Если в БД ещё нет решений (демо‑режим), backend формирует синтетические метрики и серии:
`backend/app/api/v1/routes.py` генерирует правдоподобные PD/EL на основе детерминированного
сидирования, чтобы графики выглядели как живые данные, а не нули.

На frontend при отсутствии ответа API включается аналогичная симуляция
`frontend/lib/dashboard-simulator.ts`.

### 5. Страница скоринга (Score)

- **PD**: результат модели (`ScoreResponse.pd`).
- **Ожидаемые потери**: `pd * 0.5 * loan_amount` — упрощённая формула EL.
- **Рекомендация**: `approve` или `review` в зависимости от PD.
- **Топ‑факторы**: `ScoreResponse.top_factors` — объяснение ключевых признаков.

### 6. Страница оптимизации портфеля

- **Вход**: список заявок + бюджет.
- **Механика**:
  - Каждую заявку скорим через ML.
  - Считаем ожидаемую прибыль `expected_profit`.
  - Отбираем заявки по максимальной прибыли при ограничении бюджета.
- **Где реализовано**: `backend/app/jobs/runner.py` (`_run_optimize`).

### 7. Очередь задач (Jobs)

- **Job** — асинхронная операция (оптимизация или retrain).
- **SSE‑лог**: `/api/v1/jobs/{id}/events` стримит события, события пишутся в `JobEvent`.
- **Зачем**: позволяет пользователю видеть ход долгих операций в реальном времени.

### 8. Темы и адаптивность

- **Темы**: CSS‑переменные в `frontend/app/globals.css` задают корректные цветовые значения
  для светлой и тёмной темы, включая графики и градиенты.
- **Адаптивность**: `frontend/components/app-shell.tsx` превращает меню в выезжающую панель
  на мобильных экранах.

## Что делать дальше

1. Соберите и запустите все сервисы:
   ```bash
   docker compose up --build
   ```
2. Откройте UI:
   - `http://localhost:3000`
3. Проверьте backend:
   - `http://localhost:8000/health`
   - `http://localhost:8000/docs`
4. Запустите оптимизацию портфеля:
   - UI → **Portfolio optimize** → **Run optimization job**
5. Откройте live-лог job:
   - UI → **Jobs** → выберите job → наблюдайте SSE лог.

### Пример запроса

```bash
curl -X POST http://localhost:8000/api/v1/score \
  -H "Content-Type: application/json" \
  -H "X-API-Key: local-dev-key" \
  -d '{
    "age": 35,
    "income": 75000,
    "employment_years": 5,
    "debt_to_income": 0.3,
    "credit_history_months": 60,
    "delinquencies": 0,
    "loan_amount": 20000,
    "loan_term_months": 36,
    "interest_rate": 12.5
  }'
```

## OpenAPI снапшоты

```bash
make export-openapi
```

Снапшоты лежат в `openapi/openapi.json` и `openapi/openapi.yaml`.

## Как это закрывает лабораторную по синхронизации

SYNC-LAB точки:
- `backend/app/core/sync.py`: `scoring_semaphore` ограничивает параллельные скоринги.
- `backend/app/core/sync.py`: `model_lock` защищает модель во время retrain.
- `backend/app/core/sync.py`: `job_channels` (Condition) уведомляет SSE подписчиков.
- `backend/app/jobs/runner.py`: использование Semaphore/Lock при запуске job.

## Тесты

```bash
cd backend
pytest
```
